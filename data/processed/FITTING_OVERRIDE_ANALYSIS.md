# 初速フィッティング・Override ロジック解析レポート

コードは変更していません。実データと計算ロジックの突き合わせのみ実施。

---

## 1. 現状実装の要約

### 1.1 Step 7: `apply_conservative_long_override`

- **位置**: `pipeline.py` で select 確定後、`_enforce_final_safety` の直前に実行。
- **役割**: 「中間の短窓で過大評価」「last_resort で過小評価」を救済するため、**full または long ウィンドウ**で置き換えを試みる。
- **条件 (抜粋)**:
  - **A)** `last_resort` または `sel_r2 < 0.70`: full_r2≥0.85 かつ full_slope≥sel_slope×1.25 → full 採用; など。
  - **B)** sel_n≤6, t_ratio≥0.08, sel_slope≥full_slope×1.40, long_r2≥0.85 → long 採用。
  - **C)** t_ratio≥0.55, sel_slope≥full_slope×1.35, full_r2≥0.90 → long 採用。
  - **D)** full_r2≥sel_r2+0.05 かつ full_slope≥sel_slope×1.10 → full 採用。
  - **E)** t_ratio≥0.45, full_r2≥sel_r2−0.01, full_slope≥sel_slope×0.75 → full 採用。
- **重要**: 置き換え後に `_enforce_final_safety(new_sel, r2_min=used_params["r2_min"], ...)` を実行。**ここで r2_min=0.98 のままなので、full/long の r2 が 0.98 未満だと置き換えが破棄され、元の sel が返る。**

### 1.2 1列目 (col==1) の救済

- **位置**: `pipeline.py` の `except FitSelectionError` 内。
- **内容**: excluded になったときだけ、col==1 なら先頭 2 点または 3 点で線形フィットを試し、slope≥slope_min なら status=ok にする（`_col1_rescue`）。初速らしき 2〜3 点でも許容して REA 計算が崩れないようにしている。

### 1.3 点線（補完）について

- **REA/abs の曲線**: `polymer_timeseries.py` では、**観測がある heat_min の点だけ**で指数減衰フィット（または polyline）を描いている。excluded の well はその heat_min の (t, aa)/(t, rea) が NaN なので**点が存在せず**、曲線は「観測がある点だけ」でフィットされる。
- **点線が使われている箇所**: **曲線の時間方向の拡張**（観測範囲の前後を 0〜60 min まで延ばす部分）が `linestyle=(0, (2.4, 2.4))` で描かれており、**「excluded の点を点線で補完する」専用ロジックはない**。excluded は「その heat の点が無い」として扱われ、他 heat の点だけでフィット・プロットされる。

---

## 2. 問題ウェル一覧と「あるべきフィット」（実データから計算）

| run       | plate  | well | 現在 slope | 目標 slope | 目標の説明 |
|-----------|--------|------|------------|------------|------------|
| 260205-R2 | plate2 | A6   | 0.6267     | 0.3086     | 全体 or 先頭2点除外全体 or 末尾3点除外 |
| 260205-R2 | plate2 | A7   | 0.1200     | 0.1161     | 全体採用（4点R2最大化ではなく） |
| 260205-R2 | plate2 | C6   | 0.4016     | 0.3156     | 先頭9点（後半窓は過大評価） |
| 260205-R2 | plate2 | C7   | 0.2267     | 0.1330     | 3点目〜最後（先頭2点除外） |
| 260205-R2 | plate1 | F6   | 0.3595     | 0.3429     | 先頭7点 or 全体（中間窓は避ける） |
| 260205-R2 | plate1 | G7   | 0.0897     | 0.2195     | 中間以降 or 全体（ラグ型） |
| 260205-R2 | plate1 | H7   | 0.1981     | 0.1058     | 全体（中間6点は偶然の上昇） |
| 260205-R2 | plate1 | H6   | 0.2595     | 0.2900     | 全体（現状は過小評価） |
| 260205-R1 | plate1 | H7   | 0.2267     | 0.1520     | 4点目〜20点目 or 全体（4–7点は過大） |
| 260205-R3 | plate1 | H7   | 0.3352     | 0.2149     | 先頭12点（中間7–12は偶発的） |

---

## 3. Override のシミュレーション結果

- **前提**: `apply_conservative_long_override` を全 OK ウェルに適用。last_resort 等で cur_r2<0.70 のときは safety に r2_min=0.55 を渡す（本番の used_params に合わせた想定）。
- **結果**:
  - **問題ウェル**  
    - **G7 (R2 plate1)**: 0.090 → 0.193（目標 0.219 に近い）**修正される**。  
    - **R1 H7**: 0.227 → 0.136（目標 0.152 に近い）**修正される**。  
    - **その他 8 件**: いずれも **override で変化なし**（cur のまま）。
  - **非問題ウェル**: override で **変化したウェルは 0 件**（他は壊れない）。

### 3.1 変化しない理由（設計上のボトルネック）

- **R2 H7, A6, C6, C7, R3 H7 など**  
  - 条件 B/C/D/E で「full や long で置き換え」は候補になるが、**置き換え後の `_enforce_final_safety` で r2_min=0.98 が使われている**。  
  - 全体フィットの r2 は 0.80〜0.95 程度のことが多く、0.98 を下回るため **置き換えがすべて却下**され、元の sel が返っている。
- **H6 (R2 plate1)**  
  - 条件 D（full_r2 ≥ sel_r2+0.05 かつ full_slope ≥ sel_slope×1.10）で full が選ばれうるが、同様に safety の r2_min=0.98 で full が通らない可能性がある（要確認）。
- **A7 (R2 plate2)**  
  - last_resort だが cur_r2=0.60。full_r2=0.8976 で A の「full_r2≥0.85」は満たすが、full_slope≥sel_slope×1.25 は満たさず、かつ safety で r2_min=0.55 を使うと full は通る。シミュレーションでは A7 は「変化なし」だったため、**A の full 採用条件（1.25 倍）が厳しい**か、別枝で long が選ばれ safety で落ちている可能性がある。

結論: **「中間/後半の過大評価を full で正す」ために full を採用する分支では、現状の safety に 0.98 をそのまま使うと、多くの問題ウェルで置き換えが破棄されている。**

---

## 4. 汎用ロジックで必要な修正の方向性（コード変更は未実施）

- **Override 専用の safety 緩和**  
  - full/long への置き換え時だけ、**r2_min を下げる**（例: 0.85 や 0.80）。  
  - または「置き換え理由が B/C/D/E のときは max_t_end のみ緩め、r2 は別閾値」など、**override 時のみ別パラメータ**を渡す。
- **「偶然の上昇」の検出**  
  - 前半の傾きが選択窓の 30% 未満、前半 r2 が低い、全体 r2 が 0.75 以上、などで **「中間の短窓は採用しない → full を採用」** を明示的に許す条件を追加する。
- **ラグ型（G7 型）**  
  - 現状の A と relaxed r2_min で G7 はシミュレーション上は修正されている。本番で last_resort 時に used_params の r2_min が 0.55 になっているか要確認。
- **1列目**  
  - 現状どおり「excluded 時のみ 2〜3 点で救済」でよい。他列は「点線で補完」は時間拡張のみで、excluded は点が無い扱いなので、**1列目だけ除外条件を緩めて必ずフィットさせる**方針と矛盾しない。

---

## 5. Codex 実装が「正しく動いているか」の結論

- **正しく動いている部分**  
  - 1列目救済（col==1 で 2〜3 点許容）、Step 7 の条件式（A〜E）の意図、`_best_long_window_stats`（min_frac=0.6, max_trim=3）の使い方。
- **正しく動いていない／不十分な部分**  
  - Override で full/long に置き換えたあと、**同じ r2_min=0.98 で _enforce_final_safety しているため**、多くの問題ウェル（R2 H7, A6, C6, C7, R3 H7, 場合により H6, A7）で置き換えが破棄されている。  
  - その結果、**問題ウェル群のうち実際に修正されるのは G7 と R1 H7 程度**であり、ユーザーが期待する「全問題ウェルで目標に近いフィット」には届いていない。
- **点線補完**  
  - REA/abs の曲線で「excluded の点を点線で補完する」ロジックは**ない**。点線は「観測範囲の前後の時間拡張」にのみ使われている。

---

## 6. 再現用スクリプト

- `scripts/analyze_problem_wells.py`: 問題ウェルの現状・全体・目標 slope を一覧。
- `scripts/simulate_override_logic.py`: 全 OK ウェルに override を適用し、問題ウェルの変化有無と非問題ウェルの変更有無を出力。
