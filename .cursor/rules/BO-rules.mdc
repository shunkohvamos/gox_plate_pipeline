---
description: 
alwaysApply: true
---

# Bayesian Optimization v2 — 熱耐性設計（Project Rule）

## 0. ゴール（Colab→Cursorで達成すべきこと）
BOは「次の候補を出す」だけでなく、
- どのデータ（raw/解析run）に基づき
- どの補正（アンカー/ラウンド統合）を行い
- どのモデル/獲得関数/制約で
- なぜその候補を選んだか
を **再現可能・監査可能**に残す“意思決定システム”である。

## 1. 追跡可能性（BOにも必須）
- BOが参照した解析結果は必ず `run_id` を持つ（run manifestでrawに追跡可能）。
- BOの出力（提案リスト、学習データセット、モデル要約、図）にも `run_id` / `bo_run_id` を付与し、参照した run_id の一覧を保存する。
- 「提案理由ログ」を必須とする（後述）。

## 2. 正規化と統合（アンカーが前提）
- ラウンド/日/プレート間の系統誤差を想定し、共通サンプル（アンカー）で補正して統合する。
- アンカーが無いデータは、原則として別グループ扱い（統合しない）か、不確実性を増やして扱う。
- 補正の結果（補正前→補正後、補正量、適用条件）を必ず保存し、manifestに残す。

## 3. 目的関数（“t50中心”＋不確実性）
- 基本指標は t50（または同等の半減期指標）を中核に置く。
- GOx基準の FoG（必要なら log FoG）など「比較用のスカラー」を定義する場合、
  - 定義をバージョン管理し、旧定義と比較可能にする
  - 推定誤差（不確実性）も併記し、モデルの観測ノイズとして反映する
- “見た目が良いから”で目的関数を差し替えない。変更はルール・テスト・過去結果比較とセット。

## 4. 制約（実験として成立する候補だけを出す）
- 組成空間（例：三角座標の比率）は制約内で探索（和=1、上下限など）。
- 実験上の成立条件（溶解性、相分離、粘度、コロイド安定性など）があるなら、
  - ハード制約（候補から除外）または
  - ソフト制約（ペナルティ / 安全BO）
  を明示して運用する。
- “性能は高そうだが実験できない提案”を出さない。

## 5. 探索戦略（batch BOを前提）
- 実験は通常バッチで回るため、BOは batch 提案（q-EI/q-UCB等）を基本とする。
- 探索（uncertainty）と活用（mean）の比率は設定として明示し、ラウンドごとに記録する。
- 同一ラウンド内の候補は多様性（組成距離など）を確保し、同じ近傍に固めすぎない。

## 6. ロバスト性（ノイズ・外れ値・再現性）
- 外れ値は原則「黙って捨てない」。理由・検知ロジックを記録し、
  モデルでは不確実性（ノイズ）として扱う設計を優先する。
- 再現性が低い点は重みを下げる/ノイズを上げるなど、統計的に反映する。
- 解析（初速フィット）側の例外適用（先頭点スキップ等）はBO側の学習データにも引き継ぎ、
  “信頼度”として扱えるようにする。

## 7. 提案理由ログ（必須成果物）
次の情報を候補ごとに保存する（CSV/JSONどちらでも良い）：
- bo_run_id
- 参照した解析 run_id の一覧
- 候補の設計変数（組成など）
- 予測平均・予測分散（または信用区間）
- 獲得関数値（EI/UCB等）と主要ハイパーパラメータ
- 制約判定（OK/NG、スコア）
- 採否（selected / not_selected）と理由（上位N、制約NG等）

## 用語：サロゲートマップ（surrogate map）
- **サロゲートマップ**（surrogate map）＝ BO の GP（サロゲートモデル）の出力を、設計空間（組成空間）上に**グラデーションのカラーマップ**で描いた図のこと。修正・仕様の会話ではこの用語で一括して指す。
- **含まれる図**：
  - **三角（ternary）**: 予測平均・予測標準偏差・EI・UCB の4枚（`ternary_mean_log_fog__*.png` など）
  - **2D 2×2**: x–y 平面または BMA–MTAC 平面の Mean / Std / EI / UCB の4パネル（`xy_2x2_*` または `bma_mtac_2x2_*`）
- 「サロゲートマップを〜」「surrogate map の〜」と言われたら、上記のいずれかまたは全体を指すと解釈する。三角だけ・2x2だけ・カラーバーだけなど、文脈で切り分ける。

## 8. 可視化（英語のみ + 色の永続化）
- 図中テキストは英語のみ（タイトル、軸、凡例、注釈）。
- polymer_id の色は永続ファイル（yml/json）で固定し、過去登場IDは同じ色を維持する。
- BOで作る図（**サロゲートマップ**（三角・2x2）、時系列比較、上位/下位比較など）も同じ色マップを参照する。
- 図ファイル名には bo_run_id / run_id を含め、追跡はmanifestに委ねる。

## 9. テスト（特定生データ依存は禁止）
実データの特定wellや特定ファイル名に依存せず、合成データや小さな疑似データで検証する：
- 制約を破る候補が提案されない（または選ばれない）
- アンカー補正の有無で“同一条件の順位”が極端に崩壊しない（健全性チェック）
- batch提案が近傍に固まりすぎない（多様性チェック）
- 提案理由ログが必ず出力され、必須列が揃う

## 10. 実装方針（最小差分 + 層構造）
- 既存解析ロジック（t50算出等）を勝手に変えない。
- BOは「データ整形」「補正」「モデル」「提案」「ログ/可視化」を分離し、交換可能にする。
- CLIや設定ファイルで再現できるようにし、実行ごとにmanifestを残す。
