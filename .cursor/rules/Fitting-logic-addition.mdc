---
description: Initial rate fitting — ideal window, true lag vs shallow dip, contiguous segment, rescue locally. Apply when editing fitting / rate selection logic.
alwaysApply: false
---

# 初速フィットの理想と制約条件

## 注意書き

- **特定のデータに合わせた極端なロジックの変更をしないこと。** あるプレート・ウェル・ファイルだけに合わせた閾値や例外を増やさない。
- **今後どんなデータが来ても最適なフィッティングになるようなロジックにすること。** 本ルールの「理想」と「制約」に基づき、新しいデータが来ても同じ原則で動くようにする。

## 理想のフィッティング（何を目指すか）

- **初速の定義**: 反応が**初期レジーム**にある区間での**局所線形近似の傾き**。基質枯渇・生成物阻害・バックグラウンドの影響がまだ小さい区間であり、傾きが「速度」として解釈できる。
- **背景**: シグナルは生成物の累積で増加することが多く、熱失活などで時間とともに傾きが低下しやすい。**できるだけ早い**妥当な線形窓が初速に対応する。すでに曲がり始めた区間を直線で食わない。
- **窓の理想**: **十分に線形**で**点数も足り**、かつ**反応として妥当**な範囲のうち、**できるだけ開始が早い**窓を選ぶ。「直線っぽさ」より「反応の妥当性」を優先する（R² が高くても、後半の平坦化した区間を直線で食うのは避ける）。
- **窓選択の優先順位**: (1) 開始が早い窓を優先（遅い開始にはペナルティ）, (2) その早い範囲内で直線性が高い窓を優先, (3) 点数が十分な窓を優先。

## 制約：開始点をいつ動かしてよいか

- **許す理由は「本当のラグを飛ばすとき」だけ。** **本当のラグ**とは、先頭に続く**持続的な**平坦またはノイジーな区間であり、反応の初期レジームに含まれないもの（混合・平衡・デッドタイム等）。**浅いディップ**（1 点程度の下がりや小さな揺れで、すでに y[0] から十分上にある局所最小）はラグとみなさない → 開始点を進めず start_idx=0 のままにし、先頭の数点を候補に含める。
- **「最初の N 点を必ず含める」は全局には課さない。** 本当のラグがあるトレースで破綻する。先頭スキップは「持続的な平坦/ノイジーな立ち上がり」がある場合に限り許し、**スキップ上限**（点数または時間）を設ける。

## 制約：フィッティング対象が「一つの連続区間」に限定されているとき

- **状況**: パイプラインや前段で、データが**一つの連続区間**に限定されていることがある（例：検出された不連続の前だけ、あるレジーム内の点だけ）。その区間が**フィッティングの定義域**である。
- **ルール**: その区間では**原則として全区間の点を候補にする**（区間内で start_idx=0）。区間の「先頭」を、区間内に本当のラグがない限り不当に除外しない。意図は「この区間全体をフィットに使ってよい」であり、区間の先頭に明らかなラグがある場合だけ開始点を遅らせる。
- **区間内の例外**: 区間の先頭がノイジー/平坦で、その後に明確な線形上昇が続く場合は、「明確な初速部分」だけを取ってよい（ノイジーな先頭を飛ばして初速部分から始める）。

## 設計原則

- **「救済は局所的に、正常系は不変」**: 例外となるトレース型を救うとき、既に正しくフィットしているウェルの挙動を変えない。変更後は狙ったトレース型だけが変わることを確認する。広範囲に変わったら設計が正常系を侵食している。

## 減少トレース（対応する場合）

- 負の傾きが「反応」か「測定系のアーティファクト」かをまず問う。救済する場合はガードレールを満たす場合のみ。R² 閾値をグローバルに下げない。救済は特定のトレース型に限定する。

## 禁止事項

- 開始点・窓選択の変更で、既に正しくフィットしているトレース型（本当のラグを持つデータ、または「初速部分のみ採用」が正しい区間）を壊さないこと。

## 監査（ログ・診断）

- 先頭点をスキップした場合（開始インデックス > 0）は、スキップした点数または開始時刻を出力（CSV やログ）に記録し、追跡可能にする。

## テスト要件

- 浅いディップのみの上昇トレース: 先頭の数点が候補に含まれること。
- フィッティング定義域が一つの連続区間に限定されている場合: その区間の点が原則としてすべて候補に含まれること（区間内に本当のラグがある場合を除く）。
- 単調増加かつ凹なデータ: 後半の曲がり区間を含む窓が選ばれず、早い開始の線形窓が選ばれること。
- 先頭に本当のラグ/平坦/ノイズがあるデータ: 先頭の限定的なスキップが許され、スキップ後も早い窓が優先されること。
