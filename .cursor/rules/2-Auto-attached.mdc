---
description: Initial rate fitting design — earliest linear window, window priority, leading-point skip only for true lag. Apply when editing fitting. See Fitting-logic-addition.mdc for full constraints.
alwaysApply: false
---

# 初速フィット（initial rate fitting）の設計思想

開始点・窓選択の詳細な制約（本当のラグと浅いディップの区別、連続区間の扱い、救済のガードレール）は、同ディレクトリの **Fitting-logic-addition.mdc** に記載する。

- **注意**: 特定のデータに合わせた極端なロジックの変更をしないこと。今後どんなデータが来ても最適なフィッティングになるようなロジックにすること。

## 背景（物理）

- シグナルは生成物の累積で増加することが多い。
- 熱失活が入ると、時間とともに **傾き（速度）が低下**し、カーブが出やすい。
- 初速は「初期の線形近似（接線）」として定義し、曲がり始めた区間を直線で食わない。

## 目的

- “できるだけ早い線形窓” を採用して初速（傾き）を推定する。
- ただし、混合遅れ・温度平衡・気泡・装置 dead time 等で **先頭数点がアーティファクト**の可能性があるため、
  “最初の数点は例外的に捨てる余地” を持つ。

## 非交渉ルール（禁止）

- R² が高いだけで、明確に曲がった区間まで含めて直線フィットしない。
- “後半の短い窓（終盤の少数点）” を「きれい」という理由で安易に採用しない（初速の思想に反する）。
- 例外（先頭点スキップ）を無制限に許さない。

## 優先順位（窓選択の意思決定）

窓候補の比較は、少なくとも次の優先度で決める（同点なら上から優先）：

1. **開始時刻が早い窓**を優先（late start に明確なペナルティ）
2. **直線性が高い窓**を優先（曲率が強い窓は除外または大きく減点）
3. 点数が十分な窓を優先（最低点数は下回らない）

## 例外（先頭数点のスキップ）

- 先頭の少数点がアーティファクトっぽい場合に限り、先頭点をスキップして窓候補を作ってよい。
- スキップ上限（点数または時間）を必ず設ける。
- 例外適用後も “できるだけ早い線形窓” が勝つように設計する（後半窓が勝てないようにする）。

## テスト要件（特定データ依存禁止）

実データファイル名・well 名に依存せず、合成データで以下を検証する：

1. 単調増加かつ凹（傾きが時間とともに低下）なデータ：
   - 後半の曲がり区間を含む窓が採用されない（または強く不利）
   - 早い開始の線形窓が選ばれる
2. 先頭にラグ/平坦/ノイズがあるデータ（初期アーティファクト）：
   - 先頭少数点のスキップが許される
   - ただしスキップが無制限にならず、スキップ後も早い窓が優先される
3. ノイズが強いデータ：
   - R² のために終盤短窓へ逃げない（必要なら除外してよいが理由が残る）

## 監査（ログ/診断）

- 先頭点スキップをした場合は、スキップ点数/時間を記録する（図ではなく CSV/ログでよい）。
