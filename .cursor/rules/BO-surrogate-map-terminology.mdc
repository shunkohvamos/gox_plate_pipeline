---
description: BO surrogate map terminology (ternary, 2x2 gradient figures). Apply when editing or discussing BO plots / surrogate maps.
alwaysApply: false
---

# サロゲートマップ（surrogate map）— 共通用語

ユーザーとエージェントで「BO のあのグラデーション図」を一発で指すための用語。

## 定義
- **サロゲートマップ**（surrogate map）＝ ベイズ最適化で、GP（サロゲートモデル）の予測を**設計空間（組成空間）上にグラデーションのカラーマップ**で描いた図。

## 含まれる図（すべて）
- **三角図（ternary）**: 予測平均・予測 std・EI・UCB の4枚
- **2D 2×2**: x–y または BMA–MTAC の Mean / Std / EI / UCB の4パネル

## 使い方
- ユーザーが「サロゲートマップを〜」「surrogate map の〜」と言ったら、上記のいずれかまたは全体を指すと解釈する。
- 三角だけ・2x2だけ・カラーバー・軸ラベルなど、細かい指定は文脈で切り分ける。

詳細は BO-rules.mdc の「用語：サロゲートマップ」を参照。

---

## 描画ロジックと「観測点まわりの円形の色」

### ロジック概要
- **三角図**: 設計空間を simplex 上でグリッド（`ternary_plot_step`）で切り、各格子点で GP の予測（平均・std・EI・UCB）を計算 → `Triangulation` + `tripcolor(..., shading="gouraud")` で表示。観測点は白丸で上から重ね描き。
- **2×2**: (x,y) または (BMA, MTAC) の等間隔グリッド（`n_grid`）で GP を評価 → `pcolormesh(..., shading="gouraud")`。観測点は白丸で重ね描き。

### 観測点付近が円形に違う色になる理由（正しい挙動）
- **Std**: 観測点では事後分散が最小（データがあるため不確実性が小さい）。離れると std が増えるため、「観測点を中心にしたくぼみ」ができる。length scale が小さいとこのくぼみが狭く、円形の斑のように見える。
- **EI**: すでに観測した点では Expected Improvement はほぼ 0。未観測で不確実な領域で大きくなるため、観測点付近が「冷たい」円形の斑になる。
→ どちらも **GP の数学的に正しい性質**。斑が目立つのは、length scale が小さい・グリッドが粗いと境界がはっきり見えるため。

### より滑らかなグラデーションにするには
- **プロット用グリッドを細かくする**: 三角は `ternary_plot_step` を小さく（例 0.005）、2×2 は `surrogate_map_xy_grid` を大きく（例 361）。境界がなだらかに見える。
- **GP を滑らかにする**（モデル側）: スパース時の最小 length scale（`min_length_scale_sparse_isotropic`、既定 0.3）を大きくすると、くぼみが広がり等高線マップのような滑らかな地形になる（候補選択の挙動も変わる）。
- 白丸マーカーは「観測点の位置」を示すためそのまま。

### 等高線（contour lines）
- サロゲートマップには **薄い白の等高線** を重ねている（`_SURROGATE_CONTOUR_*`）。等高線本数・線幅・透明度は bo_engine の定数で調整可能。
